# Authentication System POC Design

## Goals
- Provide a unified authentication service for the Recally backend using Echo.
- Support email/password, OAuth (via Goth), API keys, JWT cookie sessions, and leave room for WebAuthn attestation/login.
- Make the system modular so UI clients (web, extensions, future mobile) can reuse the same REST APIs.
- Keep the domain model explicit and migration-friendly by separating identities, credentials, sessions, and access policies.

## High-Level Components
1. **Identity Service (`internal/core/auth/`)**
   - Coordinates credential validation, token issuance, and account lifecycle.
   - Abstracts storage via repositories generated by SQLC (`internal/pkg/db/auth`).
2. **Credential Providers**
   - Password provider: bcrypt hashing & verification.
   - OAuth provider: Goth adapters per provider (`internal/pkg/auth/goth`).
   - API key provider: high-entropy key generation and HMAC comparison.
   - WebAuthn provider (future): stored public keys and attestation metadata.
3. **Token Service**
   - Issues and validates JWTs for browser/API clients. Stores refresh/sessions for rotation.
4. **HTTP Integration (`internal/port/httpserver/auth`)**
   - Request handlers for login, signup, OAuth redirects/callbacks, API key CRUD, WebAuthn ceremonies.
   - Middleware that loads the active principal into Echo context.
5. **Job/Event Hooks**
   - Optional publisher for audit logs (login, key creation, suspicious activity).

## Database Schema
The schema splits user identity, credential modalities, and active sessions. Primary keys use ULIDs for ordering & uniqueness.

### Core Tables
- `auth_identities`
  - `id ULID PRIMARY KEY`
  - `email CITEXT UNIQUE`
  - `display_name TEXT`
  - `created_at TIMESTAMPTZ`
  - `updated_at TIMESTAMPTZ`

- `auth_identity_profiles`
  - `identity_id ULID REFERENCES auth_identities`
  - `avatar_url TEXT`
  - `locale TEXT`
  - `metadata JSONB`

### Credential Tables
- `auth_password_credentials`
  - `identity_id ULID PRIMARY KEY REFERENCES auth_identities`
  - `password_hash TEXT`
  - `password_salt TEXT NULL` (allows migration to scrypt/argon)
  - `password_version SMALLINT`
  - `last_rotated_at TIMESTAMPTZ`

- `auth_oauth_accounts`
  - `id ULID PRIMARY KEY`
  - `identity_id ULID REFERENCES auth_identities`
  - `provider TEXT` (e.g., `github`, `google`)
  - `provider_user_id TEXT`
  - `profile JSONB`
  - `access_token TEXT`
  - `refresh_token TEXT`
  - `token_expires_at TIMESTAMPTZ`
  - `created_at TIMESTAMPTZ`
  - Unique index on (`provider`, `provider_user_id`).

- `auth_api_keys`
  - `id ULID PRIMARY KEY`
  - `identity_id ULID REFERENCES auth_identities`
  - `name TEXT`
  - `prefix TEXT` (first 6 chars for lookup)
  - `secret_hash TEXT`
  - `last_used_at TIMESTAMPTZ`
  - `created_at TIMESTAMPTZ`
  - `revoked_at TIMESTAMPTZ NULL`

- `auth_webauthn_credentials`
  - `id ULID PRIMARY KEY`
  - `identity_id ULID REFERENCES auth_identities`
  - `credential_id BYTEA UNIQUE`
  - `public_key BYTEA`
  - `sign_count BIGINT`
  - `attestation_type TEXT`
  - `transports TEXT[]`
  - `created_at TIMESTAMPTZ`

### Session & State Tables
- `auth_sessions`
  - `id ULID PRIMARY KEY`
  - `identity_id ULID REFERENCES auth_identities`
  - `client_type TEXT` (`web`, `api`, `bot`)
  - `ip_address INET`
  - `user_agent TEXT`
  - `refresh_token_hash TEXT`
  - `expires_at TIMESTAMPTZ`
  - `revoked_at TIMESTAMPTZ`

- `auth_jwt_blacklist`
  - `jti UUID PRIMARY KEY`
  - `expires_at TIMESTAMPTZ`

- `auth_oauth_states`
  - `state TEXT PRIMARY KEY`
  - `provider TEXT`
  - `redirect_uri TEXT`
  - `code_verifier TEXT`
  - `expires_at TIMESTAMPTZ`

### Audit Tables
- `auth_events`
  - `id ULID PRIMARY KEY`
  - `identity_id ULID`
  - `event_type TEXT`
  - `payload JSONB`
  - `occurred_at TIMESTAMPTZ`

## Domain Services

### Credential Validation Flow
1. Look up identity by email / provider key / API key prefix.
2. Delegate to provider-specific validator (password hash check, API key hash comparison, OAuth token introspection if needed).
3. Return `AuthPrincipal` struct with identity, scopes, and session metadata.

### JWT Issuance
- Issue short-lived access tokens (15m) signed with HS256/EdDSA and set as `HttpOnly` cookie.
- Generate refresh token stored hashed in `auth_sessions`. Rotate on each use to mitigate replay.
- Encode `jti` claim to support blacklist on logout.

### API Key Management
- Identity owners can create named API keys via handler.
- Keys use format `rec_<env>_<prefix>.<secret>` where prefix is stored to lookup hashed secret.
- Middleware checks `X-Api-Key` header, splits prefix, fetches key, constant-time compares hash, ensures not revoked.

### OAuth via Goth
- Register providers at boot using config (`GITHUB_KEY`, etc.).
- Login handler generates `state` + PKCE `code_verifier`, stores in `auth_oauth_states`, redirects to provider URL via Goth.
- Callback handler verifies state, fetches user profile, matches `provider_user_id` or email, optionally creates identity, links `auth_oauth_accounts`, issues session tokens.

### WebAuthn (Future Support)
- Registration ceremony stores challenge in Redis (ephemeral) keyed by session id.
- Upon completion, persist credential record in `auth_webauthn_credentials`.
- Login ceremony verifies signature using stored public key and updates `sign_count`.

## Echo Integration

### Routes (`/api/v1/auth`)
- `POST /signup` → email/password registration.
- `POST /login` → email/password login.
- `POST /logout` → invalidate session + JWT blacklist entry.
- `POST /token/refresh` → rotate refresh token, issue new JWT.
- `GET /me` → return current principal.
- `POST /oauth/:provider/login` → generate redirect (with PKCE optional).
- `GET /oauth/:provider/callback` → handle provider response.
- `GET /apikeys` / `POST /apikeys` / `DELETE /apikeys/:id` → manage API keys.
- `POST /webauthn/attestation/options` / `POST /webauthn/attestation/result`.
- `POST /webauthn/assertion/options` / `POST /webauthn/assertion/result`.

### Middleware
- `authMiddleware` resolves user using order: session cookie JWT → refresh token → API key → optional WebAuthn assertion header.
- Attaches `*auth.Principal` to context via `contextKeyPrincipal`.
- Provides helper `RequireScopes(scopes ...string)` to guard routes.

### Request Lifecycle Example (Email Login)
1. Handler parses payload, fetches identity by email.
2. Password provider verifies hash.
3. Session service creates new session row + refresh token.
4. JWT service issues access token with `Set-Cookie` header.
5. Response returns user profile + scopes.

### Request Lifecycle Example (API Key)
1. Client sends `X-Api-Key` header.
2. Middleware splits prefix, loads key, constant-time compares hash.
3. On success, attaches principal with `AuthMethodAPIKey` and allowed scopes.
4. Downstream handlers rely on context for authorization.

## Configuration & Secrets
- Environment variables for JWT secret, token lifetimes, Goth provider keys, Argon2 parameters, API key length, session cleanup TTL.
- Provide `config.AuthConfig` struct consumed by handlers/services.

## Background Processes
- `auth.Cron` job to delete expired OAuth states, revoke stale sessions, rotate API keys if flagged.
- Optional webhook emitter for security notifications (new login, password change).

## Extensibility Considerations
- Additional providers (SAML, enterprise SSO) can implement `CredentialProvider` interface with minimal disruption.
- WebAuthn tables already present; enabling requires implementing ceremony endpoints and storing per-device metadata.
- Microservice friendly: repositories abstract SQLC queries; swapping to different store would require new repo implementations but minimal handler changes.

## POC Implementation Outline
1. Define SQL migrations under `database/migrations/auth_poc_*` using schema above.
2. Add SQLC queries in `database/queries/auth/` for CRUD operations.
3. Implement domain services in `internal/core/auth/` with interfaces for credential providers, session manager, token signer.
4. Wire providers in `internal/pkg/auth/` (password, Goth, API key, WebAuthn stub).
5. Register handlers in `internal/port/httpserver/routes.go` under `/api/v1/auth` group.
6. Expose middleware from `internal/port/httpserver/middleware/auth.go` and apply to protected routes.
7. Update configuration structs and env parsing for auth-specific settings.
8. Provide integration tests for login flows and API key validation using Echo's test client.
